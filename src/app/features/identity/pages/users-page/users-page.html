<section class="space-y-4">
  <div class="flex flex-wrap items-center justify-between gap-3">
    <div>
      <h1 class="text-lg font-semibold text-gray-900">Users</h1>
      <p class="text-sm text-gray-500">Manage user accounts and access.</p>
    </div>
    <cxs-button size="sm" (click)="onOpenAddUser()">Add user</cxs-button>
  </div>

  @if (error()) {
    <div
      class="rounded-md border border-red-200 bg-red-50 px-4 py-2 text-sm text-red-700"
    >
      {{ error() }}
    </div>
  }

  <cxs-card>
    <cxs-data-table
      caption="All users"
      [allowOverflow]="true"
      [bordered]="true"
      [columnBorders]="true"
      [columns]="columns"
      [data]="rows()"
      [loading]="loading()"
      [manualFilter]="true"
      [manualPagination]="true"
      [manualSort]="true"
      [pageIndex]="pageIndex()"
      [pageSize]="pageSize()"
      [showFilters]="true"
      [showGlobalSearch]="true"
      [sortDirection]="sortDirection()"
      [sortKey]="sortKey()"
      [striped]="true"
      [total]="totalCount()"
      (filterChange)="onFilterChange($event)"
      (pageChange)="onPageChange($event)"
      (pageSizeChange)="onPageSizeChange($event)"
      (sortChange)="onSortChange($event)"
    >
      <ng-template cxsDataTableCell="actions" let-row>
        <div class="relative flex justify-end">
          <button
            type="button"
            class="inline-flex h-8 w-8 items-center justify-center rounded-md text-gray-500 hover:bg-gray-100 hover:text-gray-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-400"
            [attr.aria-expanded]="openMenuId() === $any(row).id"
            aria-haspopup="true"
            aria-label="Open actions menu"
            (click)="onToggleActionMenu($any(row).id, $event)"
          >
            <svg
              class="h-4 w-4"
              viewBox="0 0 16 16"
              fill="currentColor"
              aria-hidden="true"
            >
              <circle cx="8" cy="3.5" r="1.5" />
              <circle cx="8" cy="8" r="1.5" />
              <circle cx="8" cy="12.5" r="1.5" />
            </svg>
          </button>
          @if (openMenuId() === $any(row).id && menuPosition()) {
            <div
              class="fixed z-50 w-44 rounded-md border border-gray-200 bg-white py-1 text-sm shadow-lg"
              [style.top.px]="menuPosition()!.top"
              [style.left.px]="menuPosition()!.left"
              (click)="$event.stopPropagation()"
            >
              <button
                type="button"
                class="flex w-full items-center px-3 py-2 text-left text-gray-700 hover:bg-gray-50"
                (click)="onEditUser($any(row).id); onCloseActionMenu()"
              >
                Edit user
              </button>
              <button
                type="button"
                class="flex w-full items-center px-3 py-2 text-left text-gray-700 hover:bg-gray-50"
                (click)="onEditRoles($any(row).id); onCloseActionMenu()"
              >
                Edit roles
              </button>
              <button
                type="button"
                class="flex w-full items-center px-3 py-2 text-left text-gray-700 hover:bg-gray-50"
                (click)="onEditGroups($any(row).id); onCloseActionMenu()"
              >
                Edit groups
              </button>
              <button
                type="button"
                class="flex w-full items-center px-3 py-2 text-left text-red-600 hover:bg-red-50"
                (click)="onDeleteUser($any(row).id); onCloseActionMenu()"
              >
                Delete user
              </button>
            </div>
          }
        </div>
      </ng-template>
    </cxs-data-table>

  </cxs-card>

  <cxs-dialog
    description="Create a new user account."
    title="Add user"
    [open]="addUserOpen()"
    (openChange)="onCloseAddUser()"
  >
    <form class="grid gap-4" [formGroup]="addUserForm" (ngSubmit)="onSubmitAddUser()">

      <cxs-input formControlName="username" label="Username" placeholder="Username" />


      <cxs-input formControlName="email" label="Email" placeholder="user@example.com" type="email">
        @if (addUserForm.get('email')?.touched && addUserForm.get('email')?.invalid) {
          <span cxsInputError>Enter a valid email address.</span>
        }
      </cxs-input>
      <cxs-input formControlName="phoneNumber" label="Phone" placeholder="+1 555 0100" type="tel" />
      <cxs-input formControlName="password" label="Password" placeholder="Password" type="password" />
    </form>

    @if (addUserError()) {
      <div
        class="mt-3 rounded-md border border-red-200 bg-red-50 px-3 py-2 text-xs text-red-700"
      >
        {{ addUserError() }}
      </div>
    }

    <div cxsDialogActions>
      <cxs-button variant="secondary" (click)="onCloseAddUser()">Cancel</cxs-button>
      <cxs-button
        type="submit"
        [disabled]="addUserLoading()"
        [loading]="addUserLoading()"
        (click)="onSubmitAddUser()"
      >
        Create user
      </cxs-button>
    </div>
  </cxs-dialog>

  <cxs-toast
    [duration]="3500"
    [message]="toastMessage()"
    [open]="toastOpen()"
    [title]="toastTitle()"
    [variant]="toastVariant()"
    (openChange)="onToastOpenChange($event)"
  />
</section>
